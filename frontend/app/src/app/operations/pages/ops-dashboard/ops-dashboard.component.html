<div class="container-0-ops-master">
    <!-- Navigation section -->
    <div class="container-1-ops-master-left-section">
        <h3>Processes</h3>
        <div *ngIf="processTypeIdsList$ | async as processTypeIdsList; else loading">
            <div *ngFor="let id of processTypeIdsList['ids']" (click)="selectProcessType(id)" class="selectable-item">
                {{id}}
            </div>
        </div>
    </div>
    
    
    <!-- Main section -->
    <div class="container-1-ops-dashboard-right-section">
        <ng-container *ngIf="mainSectionView === 'SelectProcessInstance'; then SelectProcessInstance"></ng-container>
        <ng-container *ngIf="mainSectionView === 'SelectStartStep'; then SelectStartStep"></ng-container>
        <ng-container *ngIf="mainSectionView === 'PerformOperations'; then PerformOperations"></ng-container>
    </div>
</div>


<!-- Auxiliary section -->
<div class="sidebar" [class.active-sidebar]="showSidebar">
    <app-ops-sidebar 
        *ngIf="auxiliarySection"
        [sidebarPackage]="sidebarPackage"
        (dataEvent)="applySidebarEffects($event)"
    >
    </app-ops-sidebar>
</div>

<!-- Optional templates -->
<ng-template #loading>
    Loading...
</ng-template>

<div class="overlay" [class.active-overlay]="showSidebar" (click)="toggleSidebar()"></div>


<ng-template #SelectProcessInstance>
    <div *ngIf=" processInstancesByProcessType; else loading">
        <div class="container-2-ops-master-top-bar">
            <h5>Select Process Instance</h5>
            <button class="button button-secondary" (click)="createNewProcess(processType)">Add New  {{processType}} Process</button>
        </div>
        <div class="table-container">
            <div class="table-row">
                Process Instance ID
            </div>
            <div class="table-row">
                Process Type
            </div>
            <div class="table-row">
                Operation Status
            </div>
        </div>
        <div *ngFor="let processInstanceEntry of processInstancesByProcessType" (click)="selectProcessInstance(processInstanceEntry._id)" class="table-container">
            <div class="table-row">
                {{processInstanceEntry._id}}
            </div>
            <div class="table-row">
                {{processInstanceEntry.process_type}}
            </div>
            <div class="table-row">
                {{processInstanceEntry.operations_status}}
            </div>
        </div>
    </div>
</ng-template>

<ng-template #SelectStartStep>
    <span *ngIf="processInstance">
        <span *ngIf="processInstance.operations_status === '00_PROCESS_CREATED'">
            Select Start Step
            <div *ngFor="let step of startSteps">
                <div (click)="selectStartStep(step)" class="clickable-div">{{step}}</div>
            </div>
        </span>
    </span>
</ng-template>

<ng-template #PerformOperations>
    <span *ngIf="processInstance">
        <div class="container-2-ops-master-top-bar">
            <div>
                Step: <b>{{processInstance.operations_status}}</b>
            </div>
        </div>

        <span *ngIf="processInstance.steps[processInstance.operations_status].event_type === 'create'">
            <div class="container-2-ops-master-top-bar">
                Create Document
            </div>
            
            <div *ngFor="let document of processInstance.steps[processInstance.operations_status].fields | keyvalue" class="container-3-ops-dashboard-tables-container">
                <div>
                    <div class="container-2-ops-master-top-bar">
                        <p>Documnet: <b>{{document.key}}</b></p>
                        <button class="button button-secondary" (click)="showAuxiliarySectionCreateDocumnent(document.key)">Document Create New / Update</button>
                    </div>
                    <div class="table-container">
                        <div *ngFor="let field of processInstance.document_instances[document.key] | keyvalue" class="table-row">
                            <span *ngIf="![processInstance.document_instances[document.key].lead_object + 's', 'lead_object', 'lead_object_fields'].includes(field.key)">
                                {{field.key}}
                            </span>
                        </div>
                    </div>
                    <div class="table-container">
                        <div *ngFor="let field of processInstance.document_instances[document.key] | keyvalue" class="table-row">
                            <span *ngIf="![processInstance.document_instances[document.key].lead_object + 's', 'lead_object', 'lead_object_fields'].includes(field.key)">
                                {{field.value}}
                            </span>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="container-2-ops-master-top-bar">
                        <p>Master data: <b>{{processInstance.document_instances[document.key].lead_object}}</b></p>
                        <button class="button button-secondary" (click)="showAuxiliarySectionCreateDocumentMasterData(document.key)">Master Create New</button>
                    </div>
                    <div *ngFor="let masterData of processInstance.document_instances[document.key][processInstance.document_instances[document.key].lead_object + 's'] | keyvalue" class="table-container">
                        <span *ngIf="masterData.value" class="table-row-container">
                            <div *ngFor="let field of masterData.value | keyvalue" class="table-row">
                                {{field.key}}
                            </div>
                        </span>
                    </div>
                    <div *ngFor="let masterData of processInstance.document_instances[document.key][processInstance.document_instances[document.key].lead_object + 's'] | keyvalue" class="table-container">
                        <span *ngIf="masterData.value" class="table-row-container">
                            <div *ngFor="let field of masterData.value | keyvalue"  class="table-row">
                                {{field.value}}
                            </div>
                        </span>
                    </div>
                </div>
            </div>
        </span>
        
        <span *ngIf="processInstance.steps[processInstance.operations_status].event_type === 'update'">
            Update
            <div *ngFor="let document of processInstance.steps[processInstance.operations_status].fields | keyvalue">
                Documnet: {{document.key}}
                <button (click)="showAuxiliarySectionUpdateDocumnent(document.key)" [disabled]="document.value.document_fields.length == 0">Update Document</button>
                <div *ngFor="let field of processInstance.document_instances[document.key] | keyvalue">
                    <span *ngIf="![processInstance.document_instances[document.key].lead_object + 's', 'lead_object', 'lead_object_fields'].includes(field.key)">
                        {{field | json}}
                    </span>
                </div>

                Master data: {{processInstance.document_instances[document.key].lead_object}}
                <div 
                    *ngFor="let masterData of processInstance.document_instances[document.key][
                            processInstance.document_instances[document.key].lead_object + 's'] | keyvalue"
                >
                    {{masterData.key}} | {{masterData.value | json}}
                </div>
            </div>
        </span>

        <span *ngIf="processInstance.steps[processInstance.operations_status].event_type === 'read'">
            read
        </span>
    </span>
    <div class="ops-dashboard-action-button-bar">
        <button class="button button-danger" (click)="cancelOperations()">Cancel</button>
        <button class="button button-primary" (click)="updateProcessInstance()">Save</button>
    </div>
</ng-template>